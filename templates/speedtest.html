<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Speedtest</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
{% include 'navLoggedin.html' %}


<!-- put this in css file maybe? only makes graph on screen without scrolling-->
<style>
    #myChart {
    max-width: 600px;
    max-height: 300px;
    width: 100%;
    height: auto;
    margin: 0 auto; /*centers graph*/
}
*{
  margin:0;
  padding:0;
  font-family: sans-serif;
}
.chartMenu{
  width: 100vw;
  height: 40px;

}
.speed{
  max-width: 600px;
    max-height: 300px;
    width: 100%;
    height: auto;
    margin: 0 auto; 
}
.chartMenu p{
  padding: 10px;
  font-size: 20px;
}
</style>

  <div class="flex-container">
    <h1>Real Time Speed Test</h1>
    <p><strong>Download Speed:</strong> <span id="download">Updating</span></p>
    <p><strong>Upload Speed:</strong> <span id="upload">Updating</span></p>
    <p><strong>Ping:</strong> <span id="ping">Updating</span></p>
  </div>
  <div class="speed">
    <canvas id = 'speedometer'></canvas>
  </div>
  <div class="container">
    <canvas id="myChart"></canvas>
  </div>
  

  <script>
    const gaugeNeedle = {
      id: 'gaugeNeedle',
      afterDatasetDraw(chart, args, plugins){
        const {ctx,data} = chart;
        ctx.save();
        const needleValue = data.datasets[0].needValue;
        xCenter = chart.getDatasetMeta(0).data[0].x;
        yCenter = chart.getDatasetMeta(0).data[0].y;
        outerRadius = chart.getDatasetMeta(0).data[0].outerRadius;
        angle = Math.PI;
        dataTotal = data.datasets[0].data.reduce((a,b) => a + b,0);
        
        let circumference =((chart.getDatasetMeta(0).data[0].circumference / Math.PI) / data.datasets[0].data[0] ) * needleValue;
        needleValueAngle = circumference + 1.5;
        ctx.translate(xCenter,yCenter);
        ctx.rotate(angle * needleValueAngle);
        //needle
        ctx.beginPath();
        ctx.fillStyle = 'cyan';
        ctx.moveTo(0 - 5,0);
        ctx.lineTo(0,-outerRadius);
        ctx.lineTo(0+ 5 ,0);
        ctx.stroke();
        ctx.fill();
        
        ctx.restore();


      }
      
    };
    const config = {
      type:'doughnut',
      data:{
        datasets: [
        {
          label: ['Download','Upload','Ping'],
          data:[1,1,1],
          circumference: 180,
          rotation: 270,
          cutout:'80%',
          needValue: 2
          

        }],
      },
      options:{
        plugins: {
          legend:{
            display: false
          }
        }
       
      },plugins: [gaugeNeedle]
    };
    const speedometer = new Chart(
      document.getElementById('speedometer'),
      config
    );
    var socket = io.connect("http://localhost:5000");

    const ctx = document.getElementById('myChart');
    const chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Download', 'Upload'],
        datasets: [{
          label: 'Speed (Mbps)',
          data: [0, 0],
          backgroundColor: ['#36a2eb', '#ff6384'],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
          }
        }
      }
    });

    socket.on('speedtest_results', function(data) {
      document.getElementById("download").innerText = data.download + " Mbps";
      document.getElementById("upload").innerText = data.upload + " Mbps";
      document.getElementById("ping").innerText = data.ping + " ms";

      chart.data.datasets[0].data = [data.download, data.upload]; //overwrites data instead of appends data
      chart.update();
      speedometer.data.datasets[0].data= [data.download, data.upload, data.ping]; // u
      speedometer.update()
    });
  </script>
</body>
</html>
